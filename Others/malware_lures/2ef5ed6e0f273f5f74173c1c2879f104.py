import os, sys
import requests
from random import randrange
from slack_sdk import WebClient
from slack_sdk.errors import SlackApiError

# Set your Slack app token and channel ID
slack_token = 'xoxb-397714243637-1232979958689-JAtH02lwx3I2XD3Ak9UmSVey'
channel_id = 'C01AKFE4D6Z'

# Set the local directory to store downloaded images
local_directory = '/home/josiah/lures'

# Initialize Slack WebClient
client = WebClient(token=slack_token)

from datetime import datetime, timedelta

# Calculate the timestamp for three years ago
three_years_ago = datetime.now() - timedelta(days=365 * 3)
three_years_ago_timestamp = three_years_ago.timestamp()

try:
    # Fetch messages from the channel
    response = client.conversations_history(channel=channel_id)
    messages = response['messages']

    # Create a directory to store downloaded images
    os.makedirs(local_directory, exist_ok=True)

    # Download and save images
    for message in messages:
        if 'attachments' in message and 'files' in message['attachments'][0]:
            img_url = message['attachments'][0]['files'][0]['url_private']
            img_path = os.path.join(local_directory, f"{randrange(10000)}_{message['attachments'][0]['files'][0]['name']}")

            with requests.get(img_url, headers={'Authorization': f'Bearer {slack_token}'}, stream=True) as r:
                with open(img_path, 'wb') as f:
                    for chunk in r.iter_content(chunk_size=8192):
                        f.write(chunk)
except SlackApiError as e:
    print(f"Error fetching messages: {e.response['error']}")
    sys.exit(1)

print("Images downloaded successfully.")

